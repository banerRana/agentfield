import asyncio

import httpx
import pytest

from main import app  # type: ignore


@pytest.mark.asyncio
async def test_summarize_notes_route(monkeypatch):
    async with httpx.AsyncClient(
        transport=httpx.ASGITransport(app=app), base_url="http://test"
    ) as client:
        response = await client.post(
            "/reasoners/quickstart/summarize_notes",
            json={"notes": "write docs"},
            headers={"x-workflow-id": "wf", "x-execution-id": "exec"},
        )

    assert response.status_code == 200
    payload = response.json()
    assert payload["summary"]
    assert payload["source"] == "mock"


@pytest.mark.asyncio
async def test_skill_endpoint(monkeypatch):
    async with httpx.AsyncClient(
        transport=httpx.ASGITransport(app=app), base_url="http://test"
    ) as client:
        response = await client.post(
            "/skills/quickstart/current_timestamp",
            json={},
            headers={"x-workflow-id": "wf", "x-execution-id": "exec"},
        )

    assert response.status_code == 200
    payload = response.json()
    assert "timestamp" in payload
    assert "epoch" in payload
